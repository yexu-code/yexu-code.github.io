<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="[TOC] 1 搭建SFTP服务器1.1 FreeSSHd下载FreeSSHd软件，并配置好SFTP服务器的IP地址、监听端口、用户名以及用户密码等信息，启动SFTP服务器。 1.2 连接SFTP服务器创建一个SFTP工具类SFTPUtil.java，里面包含各种工具接口，例如连接&#x2F;关闭SFTP服务器、向服务器上传文件、下载文件等等。 12345678910111213141516171">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2022/07/30/%E6%90%AD%E5%BB%BASFTP%E6%9C%8D%E5%8A%A1%E5%99%A8+%E6%95%B0%E6%8D%AE%E7%A8%BD%E6%A0%B8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="[TOC] 1 搭建SFTP服务器1.1 FreeSSHd下载FreeSSHd软件，并配置好SFTP服务器的IP地址、监听端口、用户名以及用户密码等信息，启动SFTP服务器。 1.2 连接SFTP服务器创建一个SFTP工具类SFTPUtil.java，里面包含各种工具接口，例如连接&#x2F;关闭SFTP服务器、向服务器上传文件、下载文件等等。 12345678910111213141516171">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="d:/中移云能力中心线上实习/图片/ssh.png">
<meta property="og:image" content="d:/中移云能力中心线上实习/图片/拆分文件测试.png">
<meta property="og:image" content="d:/中移云能力中心线上实习/图片/压缩文件测试.png">
<meta property="og:image" content="d:/中移云能力中心线上实习/图片/目录.png">
<meta property="og:image" content="d:/中移云能力中心线上实习/图片/表open.png">
<meta property="og:image" content="d:/中移云能力中心线上实习/图片/表console.png">
<meta property="article:published_time" content="2022-07-30T10:39:33.678Z">
<meta property="article:modified_time" content="2022-07-27T12:30:23.154Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/中移云能力中心线上实习/图片/ssh.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-搭建SFTP服务器+数据稽核" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/30/%E6%90%AD%E5%BB%BASFTP%E6%9C%8D%E5%8A%A1%E5%99%A8+%E6%95%B0%E6%8D%AE%E7%A8%BD%E6%A0%B8/" class="article-date">
  <time class="dt-published" datetime="2022-07-30T10:39:33.678Z" itemprop="datePublished">2022-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h1 id="1-搭建SFTP服务器"><a href="#1-搭建SFTP服务器" class="headerlink" title="1 搭建SFTP服务器"></a>1 搭建SFTP服务器</h1><h2 id="1-1-FreeSSHd"><a href="#1-1-FreeSSHd" class="headerlink" title="1.1 FreeSSHd"></a>1.1 FreeSSHd</h2><p>下载FreeSSHd软件，并配置好SFTP服务器的IP地址、监听端口、用户名以及用户密码等信息，启动SFTP服务器。<br><img src="D:\中移云能力中心线上实习\图片\ssh.png"></p>
<h2 id="1-2-连接SFTP服务器"><a href="#1-2-连接SFTP服务器" class="headerlink" title="1.2 连接SFTP服务器"></a>1.2 连接SFTP服务器</h2><p>创建一个SFTP工具类SFTPUtil.java，里面包含各种工具接口，例如连接&#x2F;关闭SFTP服务器、向服务器上传文件、下载文件等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SFTPUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ChannelSftp sftp;</span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SFTPUtil</span><span class="params">(String username, String password, String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">        <span class="built_in">this</span>.host = host;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接sftp服务器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">()</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭连接 server</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">()</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将输入流的数据上传到sftp作为文件。文件完整路径=basePath+directory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basePath  服务器的基础路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory  上传目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sftpFileName  sftp端文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input   输入流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String basePath, String directory, String sftpFileName, InputStream input)</span> <span class="keyword">throws</span> SftpException&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载文件。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory 下载目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloadFile 下载的文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> saveFile 存在本地的路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">download</span><span class="params">(String directory, String downloadFile, String saveFile)</span> <span class="keyword">throws</span> SftpException, FileNotFoundException&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好用户名、密码、IP地址和端口信息，进行连接SFTP服务器和关闭服务器连接的测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConnect</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SFTPUtil</span> <span class="variable">sftp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SFTPUtil</span>(username, password, host, port);</span><br><span class="line">    sftp.login();</span><br><span class="line">    sftp.logout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SFTP服务器连接成功!</span><br><span class="line">SFTP服务器连接关闭.</span><br></pre></td></tr></table></figure>
<h2 id="1-3-上传文件"><a href="#1-3-上传文件" class="headerlink" title="1.3 上传文件"></a>1.3 上传文件</h2><p>在SFTPUtil.java中新建一个上传文件的方法upload()，利用ChannelSftp类中的put方法上传文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String basePath, String directory, String sftpFileName, InputStream input)</span> <span class="keyword">throws</span> SftpException&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        sftp.cd(basePath);</span><br><span class="line">        sftp.cd(directory);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SftpException e) &#123;</span><br><span class="line">        <span class="comment">//目录不存在，则创建文件夹</span></span><br><span class="line">        String [] dirs = directory.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tempPath</span> <span class="operator">=</span> basePath;</span><br><span class="line">        <span class="keyword">for</span>(String dir:dirs)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == dir || <span class="string">&quot;&quot;</span>.equals(dir)) <span class="keyword">continue</span>;</span><br><span class="line">            tempPath += <span class="string">&quot;/&quot;</span> + dir;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                sftp.cd(tempPath);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(SftpException ex)&#123;</span><br><span class="line">                sftp.mkdir(tempPath);</span><br><span class="line">                sftp.cd(tempPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sftp.put(input, sftpFileName);  <span class="comment">//上传文件</span></span><br><span class="line">    System.out.println(<span class="string">&quot;上传文件至 &quot;</span> + basePath + directory + <span class="string">&quot;/&quot;</span> + sftpFileName + <span class="string">&quot; 成功!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试将一个本地文件上传到服务器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpload</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SFTPUtil</span> <span class="variable">sftp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SFTPUtil</span>(username, password, host, port);</span><br><span class="line">    sftp.login();</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\test.java&quot;</span>);</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        is = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        sftp.upload(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;/upload&quot;</span>, <span class="string">&quot;test_sftp.java&quot;</span>, is);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SftpException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    sftp.logout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SFTP服务器连接成功！</span><br><span class="line">上传文件至 //upload/test_sftp.java 成功!</span><br><span class="line">SFTP服务器连接关闭.</span><br></pre></td></tr></table></figure>

<h1 id="2-文件处理"><a href="#2-文件处理" class="headerlink" title="2 文件处理"></a>2 文件处理</h1><h2 id="2-1-文件拆分"><a href="#2-1-文件拆分" class="headerlink" title="2.1 文件拆分"></a>2.1 文件拆分</h2><p>创建一个文件工具类FileUtils，用于对文件做各种处理，如文件拆分、压缩等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将一个文件按照每若干条记录进行拆分</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> recordsNum 拆分的记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sourceDir 源文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetDir 生成的目标文件路径，在文件名最后添加了&quot;_1/2/3&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">splitFile</span><span class="params">(<span class="type">int</span> recordsNum, String sourceDir, String targetDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 压缩为GZIP文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sourceDir 源文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetDir 生成的目标文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compressFile</span><span class="params">(String sourceDir, String targetDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将List集合中的数据写入到目标文件中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list 带写入的数据集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetDir 目标文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">list2File</span><span class="params">(List&lt;?&gt; list, String targetDir)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现有一个文件AUDIT_ECEMOP_S_IAAS_9999992_RP-25_20211223_01_045952_05-01，包含1万条记录。目标是每2000条记录拆分成一个子文件，所以共可以分成5个包含2000条数据的子文件。</p>
<p>编写一个拆分文件的方法splitFile()，能够按照指定记录数拆分文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">splitFile</span><span class="params">(<span class="type">int</span> recordsNum, String sourceDir, String targetDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="comment">// 源文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(sourceDir);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourceFile);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(fis));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算源文件总记录数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lineCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(sourceFile);</span><br><span class="line">        <span class="type">LineNumberReader</span> <span class="variable">lnr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LineNumberReader</span>(fr);</span><br><span class="line">        lnr.skip(Long.MAX_VALUE);</span><br><span class="line">        lineCount = lnr.getLineNumber();</span><br><span class="line">        lnr.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需生成的文件数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">fileNum</span> <span class="operator">=</span> lineCount / recordsNum + (lineCount % recordsNum == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">recordsCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 已读取的记录数</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">fileCount</span> <span class="operator">=</span> <span class="number">1</span>; fileCount &lt;= fileNum; fileCount++)&#123;</span><br><span class="line">            <span class="comment">// 目标文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(targetDir + <span class="string">&quot;_&quot;</span> + sdf.format(date) + <span class="string">&quot;_&quot;</span> + lineCount + <span class="string">&quot;_&quot;</span> + fileNum + <span class="string">&quot;-&quot;</span> + fileCount);</span><br><span class="line">            <span class="keyword">if</span> (!targetFile.exists())&#123;</span><br><span class="line">                targetFile.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(targetFile);</span><br><span class="line">            <span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(fos));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                bw.write(line);</span><br><span class="line">                recordsCount++;</span><br><span class="line">                <span class="keyword">if</span> (recordsCount == recordsNum) &#123;</span><br><span class="line">                    recordsCount = <span class="number">0</span>;</span><br><span class="line">                    bw.flush();</span><br><span class="line">                    bw.close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recordsCount &lt; recordsNum)&#123;</span><br><span class="line">                    bw.newLine(); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            bw.close(); </span><br><span class="line">            System.out.println(<span class="string">&quot;第&quot;</span> + fileCount + <span class="string">&quot;个文件已生成.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;文件拆分结束!&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>拆分文件测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSplitFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">recordsNum</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sourceDir</span> <span class="operator">=</span> <span class="string">&quot;D:\\data\\AUDIT_ECEMOP_S_IAAS_9999992_RP-25_20211223_01_045952_05-01&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">targetDir</span> <span class="operator">=</span> <span class="string">&quot;D:\\data\\test_AUDIT_ECEMOP_S_IAAS_9999992_RP-25_20220721&quot;</span>;</span><br><span class="line">    fileUtils.splitFile(recordsNum, sourceDir, targetDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第<span class="number">1</span>个文件已生成.</span><br><span class="line">第<span class="number">2</span>个文件已生成.</span><br><span class="line">第<span class="number">3</span>个文件已生成.</span><br><span class="line">第<span class="number">4</span>个文件已生成.</span><br><span class="line">第<span class="number">5</span>个文件已生成.</span><br><span class="line">文件拆分结束!</span><br></pre></td></tr></table></figure>
<p><img src="D:\中移云能力中心线上实习\图片\拆分文件测试.png"></p>
<h2 id="2-2-压缩文件"><a href="#2-2-压缩文件" class="headerlink" title="2.2 压缩文件"></a>2.2 压缩文件</h2><p>编写一个压缩文件的方法compressFile()，将文件压缩为gzip格式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compressFile</span><span class="params">(String sourceDir, String targetDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 源文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(sourceDir);</span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourceFile);</span><br><span class="line">    <span class="comment">// 目标文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(targetDir);</span><br><span class="line">    <span class="keyword">if</span> (!targetFile.exists())&#123;</span><br><span class="line">        targetFile.createNewFile();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(targetFile);</span><br><span class="line">    <span class="type">GZIPOutputStream</span> <span class="variable">gos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(fos);</span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(fis.read(buffer) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        gos.write(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    fis.close();</span><br><span class="line">    gos.finish();</span><br><span class="line">    gos.close();</span><br><span class="line">    System.out.println(<span class="string">&quot;文件压缩成功!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将上一步拆分生成的5个子文件进行压缩。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCompressFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceDir</span> <span class="operator">=</span> <span class="string">&quot;D:\\data\\test_AUDIT_ECEMOP_S_IAAS_9999992_RP-25_20220721_&quot;</span> + i;</span><br><span class="line">        <span class="type">String</span> <span class="variable">targetDir</span> <span class="operator">=</span> <span class="string">&quot;D:\\data\\compress\\test_AUDIT_ECEMOP_S_IAAS_9999992_RP-25_20220721_&quot;</span> + i +<span class="string">&quot;.gz&quot;</span>;</span><br><span class="line">        fileUtils.compressFile(sourceDir, targetDir);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">压缩文件成功!</span><br><span class="line">压缩文件成功!</span><br><span class="line">压缩文件成功!</span><br><span class="line">压缩文件成功!</span><br><span class="line">压缩文件成功!</span><br></pre></td></tr></table></figure>
<p><img src="D:\中移云能力中心线上实习\图片\压缩文件测试.png"></p>
<h1 id="3-数据稽核"><a href="#3-数据稽核" class="headerlink" title="3 数据稽核"></a>3 数据稽核</h1><h2 id="3-1-构造数据"><a href="#3-1-构造数据" class="headerlink" title="3.1 构造数据"></a>3.1 构造数据</h2><p>首先新建一个数据库，在数据库中新建两张表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `console_os_biz_vm_host` (</span><br><span class="line">`ID` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;唯一标示，资源编码&#x27;</span>,</span><br><span class="line">`NAME` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;虚拟机名称&#x27;</span>,</span><br><span class="line">`IS_DELETE` <span class="type">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否删除 1删除0未删除&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;控制台虚拟机表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `openstack_os_biz_vm_host` (</span><br><span class="line">`ID` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;唯一标示，资源编码&#x27;</span>,</span><br><span class="line">`NAME` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;虚拟机名称&#x27;</span>,</span><br><span class="line">`IS_DELETE` <span class="type">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否删除 1删除0未删除&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;底层虚拟机表&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>数据稽核的目的是找出控制台已删除，但是底层未删除的资源（控制台和底层资源不一致）。具体来说：</p>
<ul>
<li>控制台已删除: 控制台虚拟机表中对应记录IS_DELETE字段为1</li>
<li>底层未删除: 底层虚拟机表中对应记录IS_DELETE字段为0</li>
</ul>
<p>在根目录的entity包下创建两张表对应的实体类；在dao包下创建DAO接口以及对应的xml文件；在service包下创建UserService.java，并编写向表中添加数据的接口方法。然后向两张表中添加数据。  </p>
<div align=center>
    <img src="D:\中移云能力中心线上实习\图片\目录.png" alt=""" width="250" height="350" />
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertData</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) ctx.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line"></span><br><span class="line">    String id;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="type">int</span> isDelete;</span><br><span class="line">    <span class="comment">// 产生9200条需稽核数据</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">9200</span>; i++)&#123;</span><br><span class="line">           id = <span class="string">&quot;CIDC-U-&quot;</span> + CommonUtil.generateUUID().substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">           name = <span class="string">&quot;CIDC-A-&quot;</span> + CommonUtil.generateUUID().substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">           isDelete = <span class="number">0</span>;</span><br><span class="line">           userService.addOpenstack(<span class="keyword">new</span> <span class="title class_">OpenstackOsBizVmHost</span>(id, name, isDelete));</span><br><span class="line">           isDelete = <span class="number">1</span>;</span><br><span class="line">           userService.addConsole(<span class="keyword">new</span> <span class="title class_">ConsoleOsBizVmHost</span>(id, name, isDelete));</span><br><span class="line">       &#125;</span><br><span class="line">    <span class="comment">// 产生300条正确数据,共9500条数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">300</span>; i++)&#123;</span><br><span class="line">        id = <span class="string">&quot;CIDC-U-&quot;</span> + CommonUtil.generateUUID().substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        name = <span class="string">&quot;CIDC-A-&quot;</span> + CommonUtil.generateUUID().substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        isDelete = <span class="number">1</span>;</span><br><span class="line">        userService.addOpenstack(<span class="keyword">new</span> <span class="title class_">OpenstackOsBizVmHost</span>(id, name, isDelete));</span><br><span class="line"></span><br><span class="line">        isDelete = <span class="number">0</span>;</span><br><span class="line">        userService.addConsole(<span class="keyword">new</span> <span class="title class_">ConsoleOsBizVmHost</span>(id, name, isDelete));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
添加后的部分数据如下。
<div align=center>
    <img src="D:\中移云能力中心线上实习\图片\表open.png" alt=""" width="420" height="470" />
    <img src="D:\中移云能力中心线上实习\图片\表console.png" alt=""" width="420" height="470" />
</div>
## 3.2 数据稽核
如前所述，目的是稽核出控制台已删除，但是底层未删除的资源。也即，在控制台虚拟机表中IS_DELETE字段为1，但在底层虚拟机表中IS_DELETE字段为0的记录。于是可以写出如下的SQL语句。
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> o.ID, o.NAME, o.IS_DELETE</span><br><span class="line"><span class="keyword">FROM</span> console_os_biz_vm_host c, openstack_os_biz_vm_host o</span><br><span class="line"><span class="keyword">WHERE</span> c.ID <span class="operator">=</span> o.ID <span class="keyword">AND</span> c.IS_DELETE <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> o.IS_DELETE <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
在UserService类中编写数据稽核的接口方法queryInconsistentData，用于表数据稽核，并将稽核出的数据存入List集合中。
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;OpenstackOsBizVmHost&gt; <span class="title function_">queryInconsistentData</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataAuditingDao.selectInconsistentData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
由于两张表中各有9500条数据，其中有9200条数据存在不一致问题，也就是需要被稽核出来。测试代码如下
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQueryInconsistentData</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) ctx.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">    List&lt;OpenstackOsBizVmHost&gt; listData = userService.queryInconsistentData();</span><br><span class="line">    System.out.println(<span class="string">&quot;共稽核出 &quot;</span> + listData.size() + <span class="string">&quot; 条不一致数据.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试结果如下  
`共稽核出 9200 条不一致数据.`
## 3.3 将数据写入到文件
由于上一步已经将稽核出的数据记录存入了List集合，所以需要把List集合中的数据写入到文件中。在FileUtil类中编写一个方法list2File，能够将List集合中的数据写入到目标文件。
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">list2File</span><span class="params">(List&lt;?&gt; list, String targetDir)</span>&#123;</span><br><span class="line">    <span class="comment">// 目标文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(targetDir);</span><br><span class="line">    <span class="keyword">if</span> (!targetFile.exists())&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            targetFile.createNewFile();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件创建失败!&quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Writer</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(targetFile);</span><br><span class="line">        <span class="type">BufferedWriter</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(writer);</span><br><span class="line">        <span class="keyword">for</span> (OpenstackOsBizVmHost os : (List&lt;OpenstackOsBizVmHost&gt;)list)&#123;</span><br><span class="line">            bw.write(os.getId() + <span class="string">&quot;|&quot;</span> + os.getName() + <span class="string">&quot;|&quot;</span> + os.getIsDelete());</span><br><span class="line">            bw.newLine();</span><br><span class="line">        &#125;</span><br><span class="line">        bw.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;数据写入完成!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试该方法。
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList2File</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">    <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) ctx.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">    List&lt;OpenstackOsBizVmHost&gt; listData = userService.queryInconsistentData();</span><br><span class="line">    <span class="type">String</span> <span class="variable">targetDir</span> <span class="operator">=</span> <span class="string">&quot;D:\\data\\test_inconsistentData&quot;</span>;</span><br><span class="line">    fileUtils.list2File(listData, targetDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试结果如下。  
`数据写入完成!`
## 3.4 文件处理
得到稽核出的数据文件之后，就可以利用第1、2节的内容，对文件进行拆分、压缩，然后上传到SFTP服务器。还有一个小细节需要注意，文件名中需要显示记录总数、总文件数以及文件序号，所以需要提前计算出稽核出的记录总数以及需要拆分的子文件个数，然后添加到文件名中。
![](D:\中移云能力中心线上实习\图片\拆分文件.png)
![](D:\中移云能力中心线上实习\图片\压缩文件.png)
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SFTP服务器连接成功!</span><br><span class="line">上传文件至 <span class="comment">//upload/test_inconsistentDataSplit_20220726_9200_5-1.gz 成功!</span></span><br><span class="line">上传文件至 <span class="comment">//upload/test_inconsistentDataSplit_20220726_9200_5-2.gz 成功!</span></span><br><span class="line">上传文件至 <span class="comment">//upload/test_inconsistentDataSplit_20220726_9200_5-3.gz 成功!</span></span><br><span class="line">上传文件至 <span class="comment">//upload/test_inconsistentDataSplit_20220726_9200_5-4.gz 成功!</span></span><br><span class="line">上传文件至 <span class="comment">//upload/test_inconsistentDataSplit_20220726_9200_5-5.gz 成功!</span></span><br><span class="line">SFTP服务器连接关闭.</span><br></pre></td></tr></table></figure>
# 4 总体程序
项目总体目录如下。
![](D:\中移云能力中心线上实习\图片\总体界面.png)
总体测试程序如下。
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test04</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总体测试程序</span></span><br><span class="line"><span class="comment">     * Author: LiLei  Data: 2022/7/26</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">FileUtils</span> <span class="variable">fileUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileUtils</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;******&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;******&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;******&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> **;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">homePath</span> <span class="operator">=</span> <span class="string">&quot;D:\\data\\&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dataAuditing</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="string">&quot;applicationContext.xml&quot;</span>;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(config);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) ctx.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.数据稽核,数据存入List集合</span></span><br><span class="line">        List&lt;OpenstackOsBizVmHost&gt; listData = userService.queryInconsistentData();</span><br><span class="line">        System.out.println(<span class="string">&quot;共稽核出 &quot;</span> + + listData.size() + <span class="string">&quot; 条不一致数据.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.将稽核出的List集合中的数据写入文件</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetDir</span> <span class="operator">=</span> homePath + <span class="string">&quot;test_inconsistentData&quot;</span>;</span><br><span class="line">        fileUtils.list2File(listData, targetDir);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.拆分文件</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lineCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 源文件总记录数</span></span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(targetDir);</span><br><span class="line">        <span class="type">LineNumberReader</span> <span class="variable">lnr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LineNumberReader</span>(fr);</span><br><span class="line">        lnr.skip(Long.MAX_VALUE);</span><br><span class="line">        lineCount = lnr.getLineNumber();</span><br><span class="line">        lnr.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">recordsNum</span> <span class="operator">=</span> <span class="number">2000</span>; <span class="comment">// 拆分后子文件的记录数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">fileNum</span> <span class="operator">=</span> lineCount / recordsNum + (lineCount % recordsNum == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>); <span class="comment">// 需生成的文件数</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceDir</span> <span class="operator">=</span> homePath + <span class="string">&quot;test_inconsistentData&quot;</span>;</span><br><span class="line">        targetDir = homePath + <span class="string">&quot;test_inconsistentDataSplit&quot;</span>;</span><br><span class="line">        fileUtils.splitFile(recordsNum, sourceDir, targetDir);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.压缩文件</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= fileNum; i++)&#123;</span><br><span class="line">            sourceDir = homePath + <span class="string">&quot;test_inconsistentDataSplit_20220726_9200_5-&quot;</span> + i;</span><br><span class="line">            targetDir = homePath + <span class="string">&quot;compress\\test_inconsistentDataSplit_20220726_9200_5-&quot;</span> + i +<span class="string">&quot;.gz&quot;</span>;</span><br><span class="line">            fileUtils.compressFile(sourceDir, targetDir);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.将压缩后的文件上传至SFTP服务器</span></span><br><span class="line">        <span class="type">SFTPUtil</span> <span class="variable">sftp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SFTPUtil</span>(username, password, host, port);</span><br><span class="line">        sftp.login();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= fileNum; i++)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;test_inconsistentDataSplit_20220726_9200_5-&quot;</span>;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(homePath + <span class="string">&quot;compress\\&quot;</span> + fileName + i +<span class="string">&quot;.gz&quot;</span>);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                is = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sftpFileName</span> <span class="operator">=</span> fileName + i + <span class="string">&quot;.gz&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sftp.upload(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;/upload&quot;</span>, sftpFileName, is);</span><br><span class="line">                is.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sftp.logout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/30/%E6%90%AD%E5%BB%BASFTP%E6%9C%8D%E5%8A%A1%E5%99%A8+%E6%95%B0%E6%8D%AE%E7%A8%BD%E6%A0%B8/" data-id="cl67rjoaa0001m8u7dyxq0yky" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2022/07/30/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/07/30/%E6%90%AD%E5%BB%BASFTP%E6%9C%8D%E5%8A%A1%E5%99%A8+%E6%95%B0%E6%8D%AE%E7%A8%BD%E6%A0%B8/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/07/30/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>